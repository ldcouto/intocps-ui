<form *ngIf="config" [formGroup]="form" (ngSubmit)="onSubmit()" #configForm="ngForm">

    <div class="form-horizontal">
        <div class="form-group">
            <label class="col-sm-2 control-label">Start time</label>
            <div class="col-sm-10">
                <p *ngIf="!editing" class="form-control-static">{{config.startTime}}</p>
                <input *ngIf="editing" name="startTime" [(ngModel)]="config.startTime" class="form-control">
                <div *ngIf="form.hasError('required', 'startTime')" class="alert alert-danger">This field is required.</div>
                <div *ngIf="form.hasError('invalidNumber', 'startTime')" class="alert alert-danger">Only numbers are allowed.</div>
                <div *ngIf="form.hasError('notLowerThan', 'startTime')" class="alert alert-danger">Start time has to be before end time.</div>
            </div>
        </div>

        <div class="form-group">
            <label class="col-sm-2 control-label">End time</label>
            <div class="col-sm-10">
                <p *ngIf="!editing" class="form-control-static">{{config.endTime}}</p>
                <input *ngIf="editing" name="endTime" [(ngModel)]="config.endTime" class="form-control">
                <div *ngIf="form.hasError('required', 'endTime')" class="alert alert-danger">This field is required.</div>
                <div *ngIf="form.hasError('invalidNumber', 'endTime')" class="alert alert-danger">Only numbers are allowed.</div>
                <div *ngIf="form.hasError('notHigherThan', 'endTime')" class="alert alert-danger">End time has to be after start time.</div>
            </div>
        </div>

        <div class="form-group">
            <label class="col-sm-2 control-label">Algorithm</label>
            <div class="col-sm-10">
                <p *ngIf="!editing" class="form-control-static">{{config.algorithm.name}}</p>
                <select *ngIf="editing" [ngModel]="config.algorithm" (ngModelChange)="onAlgorithmChange($event)" [ngModelOptions]="{standalone:true}" class="form-control">
                    <option *ngFor="let algorithm of algorithms" [ngValue]="algorithm">{{algorithm.name}}</option>
                </select>
            </div>
        </div>
    </div>

    <hr>

    <div *ngIf="config.algorithm.name == 'Fixed Step'" [formGroup]="form.find('algorithm')">
        <div class="form-horizontal">
            <div class="form-group">
                <label class="col-sm-2 control-label">Step size</label>
                <div class="col-sm-10">
                    <p *ngIf="!editing" class="form-control-static">{{config.algorithm.size}}</p>
                    <input *ngIf="editing" name="size" [(ngModel)]="config.algorithm.size" class="form-control">
                    <div *ngIf="form.find('algorithm').hasError('required', 'size')" class="alert alert-danger">This field is required.</div>
                    <div *ngIf="form.find('algorithm').hasError('invalidNumber', 'size')" class="alert alert-danger">Only numbers are allowed.</div>
                </div>
            </div>
        </div>
    </div>

    <div *ngIf="config.algorithm.name == 'Variable Step'" [formGroup]="form.find('algorithm')">
        <div class="form-horizontal">
            <div class="form-group">
                <label class="col-sm-2 control-label">Initial step size</label>
                <div class="col-sm-10">
                    <p *ngIf="!editing" class="form-control-static">{{config.algorithm.initSize}}</p>
                    <input *ngIf="editing" name="initSize" [(ngModel)]="config.algorithm.initSize" class="form-control">
                    <div *ngIf="form.find('algorithm').hasError('required', 'initSize')" class="alert alert-danger">This field is required.</div>
                    <div *ngIf="form.find('algorithm').hasError('invalidNumber', 'initSize')" class="alert alert-danger">Only numbers are allowed.</div>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-2 control-label">Minimum step size</label>
                <div class="col-sm-10">
                    <p *ngIf="!editing" class="form-control-static">{{config.algorithm.sizeMin}}</p>
                    <input *ngIf="editing" name="sizeMin" [(ngModel)]="config.algorithm.sizeMin" class="form-control">
                    <div *ngIf="form.find('algorithm').hasError('required', 'sizeMin')" class="alert alert-danger">This field is required.</div>
                    <div *ngIf="form.find('algorithm').hasError('invalidNumber', 'sizeMin')" class="alert alert-danger">Only numbers are allowed.</div>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-2 control-label">Maximum step size</label>
                <div class="col-sm-10">
                    <p *ngIf="!editing" class="form-control-static">{{config.algorithm.sizeMax}}</p>
                    <input *ngIf="editing" name="sizeMax" [(ngModel)]="config.algorithm.sizeMax" class="form-control">
                    <div *ngIf="form.find('algorithm').hasError('required', 'sizeMax')" class="alert alert-danger">This field is required.</div>
                    <div *ngIf="form.find('algorithm').hasError('invalidNumber', 'sizeMax')" class="alert alert-danger">Only numbers are allowed.</div>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-2 control-label">Constraints</label>
                <div class="col-sm-10">
                    <div *ngIf="editing" class="input-group">
                        <select [(ngModel)]="newConstraint" [ngModelOptions]="{standalone:true}" class="form-control">
                            <option *ngFor="let constraint of constraintConstructors" [ngValue]="constraint">{{getConstraintName(constraint)}}</option>
                        </select>
                        <span class="input-group-btn">
                            <button type="button" (click)="addConstraint(newConstraint.value)" class="btn btn-default">
                                <span class="glyphicon glyphicon-plus"></span> Add
                            </button>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="constraint-container">
            <div class="panel panel-default constraint-panel" *ngFor="let constraint of config.algorithm.constraints; let i = index">
                <div class="panel-heading">
                    <a *ngIf="editing" (click)="removeConstraint(constraint)" class="pull-right"><span class="glyphicon glyphicon-remove"></span></a>
                    {{getConstraintName(constraint)}}
                </div>
                <div class="panel-body">
                    <zero-crossing
                            [editing]="editing"
                            [ports]="outputPorts"
                            [constraint]="constraint"
                            *ngIf="constraint.type === 'zerocrossing'"></zero-crossing>

                    <bounded-difference
                            [editing]="editing"
                            [ports]="outputPorts"
                            [constraint]="constraint"
                            *ngIf="constraint.type === 'boundeddifference'"></bounded-difference>

                    <sampling-rate
                            [editing]="editing"
                            [constraint]="constraint"
                            [formGroup]="form.find('algorithm').find('constraints').at(i)"
                            *ngIf="constraint.type === 'samplingrate'"></sampling-rate>
                </div>
            </div>
        </div>
    </div>

    <hr>

    <label>Livestream Configuration</label>
    <div class="form-horizontal">
        <div class="form-group" *ngFor="let instance of config.multiModel.fmuInstances">
            <label class="col-sm-2 control-label">{{instance.fmu.name}}.{{instance.name}}</label>
            <div class="col-sm-10">
                <div class="checkbox" *ngFor="let output of getOutputs(instance.fmu.scalarVariables)">
                    <label>
                        <input type="checkbox"
                               [disabled]="!editing"
                               [checked]="isLivestreamChecked(instance, output)"
                               (change)="onLivestreamChange($event.target.checked, instance, output)">

                        {{output.name}}
                    </label>
                </div>
            </div>
        </div>
    </div>

    <hr>

    <button *ngIf="!editing" class="btn btn-default" (click)="editing = true">
        <span class="glyphicon glyphicon-edit" aria-hidden="true"></span> Edit
    </button>
    <button *ngIf="editing" class="btn btn-default" [disabled]="!configForm.form.valid">
        <span class="glyphicon glyphicon-floppy-saved" aria-hidden="true"></span> Save
    </button>
</form>

{{form?.value | json}}
{{getConfig() | json}}
